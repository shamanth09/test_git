<script th:src="@{/resources/libs/jquery.validate.js}"></script>
<script th:src="@{/resources/libs/select2/js/select2.full.min.js}"
	type="text/javascript"></script>
<script th:src="@{/resources/libs/typeahead/typeahead.bundle.min.js}"></script>
<div class="content-body">
	<div class="row">
		<div class="col-md-12">
			<div class="panel" data-fill-color="true">
				<div class="panel-heading">
					<h3 class="panel-title" th:text="${user.name}+'\'s relations'"></h3>
				</div>
				<!-- /panel-heading -->


				<div
					class="table-responsive">
					<div class="col-md-6">
						<form role="form"
							th:action="@{'relations/xhr/add-relation/'+${user.id}}"
							method="post" submit-handler="addRelationToCurrentUser"
							validate-form="">

							<div class="form-group">
								<label class="control-label" th:if="${userRole} == 'ROLE_RETAIL'">Retailers</label> 
								<label class="control-label" th:if="${userRole} == 'ROLE_WSALER'">Wholesalers</label> 
								<label class="control-label" th:if="${userRole} == 'ROLE_SUPPLIER'">Suppliers</label> 
								<select
									class="userSelection" name="secondaryUser" style="width: 100%"
									id="${userRole}">
								</select>
							</div>
							<input type="hidden" th:value="${userRole}" id="role" />

							<div class="form-group clearfix">
								<div class="pull-right">
									<a th:href="'#/user-relation/'+${user.id}" class="btn btn-default">Cancel</a>
									<button type="submit" class="btn btn-primary">Submit</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
			<!-- /panel -->
		</div>
	</div>
</div>
<script th:inline="javascript">
userApp.value("user",{
	"id":/*[[${user.id}]]*/
});

</script>

<script>

/* In select2 remote data load
 * to pass extra params
	==> requires unique id element(case sensitive id) 
	hence we need to pass data with id or override as i doing in processresults
	==> In order to display in dropdown we need to call function templateResult.
	==> In order to display selected in select box we need to call function  templateSelection.
	==> above two will work only when escapeMarkup is present.
	
*/

var userrole = $('#role').val();
  $(".userSelection").select2({
	placeholder: "select user...",
	allowClear: true,
	  ajax: {
	    url: "users/xhr/user-list",
	    dataType: 'json',
	    delay: 250,
	    data: function (params) {
	      return {
	        q: params.term, 
	        role: userrole
	      };
	    },
	    processResults: function (data) {
	    	var users = [];
	    	$.each(data, function (i, v) {
                var o = {};
                o.id = v.resultId;
                o.name = v.result;
                o.value = v.resultId;
                users.push(o);
            })
	         return {
	          results:users,
	          
	        }; 
	      }
	  },
	  escapeMarkup: function (markup) { return markup; },
	  minimumInputLength: 1,
	   templateResult:function(repo) {
		  var markup = '<option value="' + repo.id + '">' + repo.name + '</option>';
		    return markup;
		  },
	  templateSelection:function(repo) {
	      return repo.name
	   } 
	});  
</script>